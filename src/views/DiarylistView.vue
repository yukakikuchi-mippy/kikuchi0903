<template>
  <v-container class="pa-4" max-width="900">
    <v-row>
      <v-col>
        <h1>Êó•Ë®ò‰∏ÄË¶ß</h1>
      </v-col>
    </v-row>

    <v-row class="mb-4" align="center" dense wrap>
  <!-- Êó•‰ªò -->
  <v-col cols="6" sm="3" md="2">
    <v-menu
      v-model="dateMenu"
      :close-on-content-click="false"
      transition="scale-transition"
      offset-y
      min-width="auto"
    >
      <template v-slot:activator="{ on, attrs }">
        <v-text-field
          v-bind="attrs"
          v-on="on"
          label="Êó•‰ªò"
          readonly
          v-model="filterDateText"
          dense
          clearable
        ></v-text-field>
      </template>
      <v-card>
        <v-date-picker v-model="filterDate" @input="dateMenu = false"></v-date-picker>
        <v-card-actions>
          <v-btn text dense @click="filterDate = null; dateMenu = false">„ÇØ„É™„Ç¢</v-btn>
        </v-card-actions>
      </v-card>
    </v-menu>
  </v-col>

  <!-- Êó•‰ªòÊù°‰ª∂ -->
  <v-col cols="6" sm="2" md="2">
    <v-select
      v-model="filterDateType"
      :items="dateTypeOptions"
      label="Êù°‰ª∂"
      dense
    ></v-select>
  </v-col>

  <!-- ÊÑüÊÉÖ -->
  <v-col cols="6" sm="2" md="2">
    <v-select
      v-model="filterSentiment"
      :items="sentimentOptions"
      label="ÊÑüÊÉÖ"
      clearable
      dense
    ></v-select>
  </v-col>

  <!-- „ÅäÊ∞ó„Å´ÂÖ•„Çä -->
  <v-col cols="6" sm="2" md="2">
    <v-checkbox
      v-model="showFavoritesOnly"
      label="„ÅäÊ∞ó„Å´ÂÖ•„Çä„ÅÆ„Åø"
      dense
      hide-details
    ></v-checkbox>
  </v-col>

  <!-- „ÇØ„É™„Ç¢„Éú„Çø„É≥ -->
  <v-col cols="6" sm="2" md="2">
    <v-btn text small color="primary" @click="clearAllFilters" dense>„ÇØ„É™„Ç¢</v-btn>
  </v-col>
</v-row>

    <!-- „Éá„Éº„Çø„ÉÜ„Éº„Éñ„É´ -->
    <v-row>
      <v-col>
        <v-data-table
          :headers="headers"
          :items="filteredDiaries"
          :loading="loading"
          class="elevation-1"
          :sort-by.sync="sortBy"
          :sort-desc.sync="sortDesc"
        >
          <template v-slot:item="{ item }">
            <tr>
              <!-- ‰ΩúÊàêÊó• -->
              <td>
                <v-tooltip bottom open-delay="800">
                  <template v-slot:activator="{ on, attrs }">
                    <span
                      v-bind="attrs"
                      v-on="on"
                      @click="goToDetail(item)"
                      style="cursor: pointer;"
                    >
                      {{ formatDate(item.created_at_jst) }}
                    </span>
                  </template>
                  <span>„ÇÇ„Å£„Å®Ë©≥„Åó„ÅèË¶ã„Çã</span>
                </v-tooltip>
              </td>
              <!-- Êó•Ë®òÊú¨Êñá -->
              <td>
                <v-tooltip bottom open-delay="800">
                  <template v-slot:activator="{ on, attrs }">
                    <span
                      v-bind="attrs"
                      v-on="on"
                      @click="goToDetail(item)"
                      style="cursor: pointer;"
                    >
                      {{ truncateText(item.text, 20) }}
                    </span>
                  </template>
                  <span>„ÇÇ„Å£„Å®Ë©≥„Åó„ÅèË¶ã„Çã</span>
                </v-tooltip>
              </td>
              <!-- AI„Ç≥„É°„É≥„Éà -->
              <td>
                <v-tooltip bottom open-delay="800">
                  <template v-slot:activator="{ on, attrs }">
                    <span
                      v-bind="attrs"
                      v-on="on"
                      @click="goToDetail(item)"
                      style="cursor: pointer;"
                    >
                      {{ truncateText(item.ai_text, 20) }}
                    </span>
                  </template>
                  <span>„ÇÇ„Å£„Å®Ë©≥„Åó„ÅèË¶ã„Çã</span>
                </v-tooltip>
              </td>
              <!-- ÊÑüÊÉÖ„Çπ„Ç≥„Ç¢ -->
              <td>
                <v-tooltip bottom open-delay="800">
                  <template v-slot:activator="{ on, attrs }">
                    <span
                      v-bind="attrs"
                      v-on="on"
                      @click="goToDetail(item)"
                      style="cursor: pointer;"
                    >
                      <SentimentDisplay :score="item.sentiment" />
                    </span>
                  </template>
                  <span>„ÇÇ„Å£„Å®Ë©≥„Åó„ÅèË¶ã„Çã</span>
                </v-tooltip>
              </td>
              <!-- Êìç‰Ωú -->
              <td>
                <FavoriteButton
                  :diaryId="item.diary_id"
                  :initialFavorite="item.is_favorite"
                  @update="val => item.is_favorite = val"
                  @click.stop
                />
                <v-tooltip bottom :open-delay="500">
                  <template v-slot:activator="{ on, attrs }">
                    <v-btn
                      small
                      icon
                      color="error"
                      v-bind="attrs"
                      v-on="on"
                      @click.stop="confirmDelete(item.diary_id)"
                    >
                      <v-icon>mdi-delete</v-icon>
                    </v-btn>
                  </template>
                  <span>ÂâäÈô§</span>
                </v-tooltip>


              </td>
            </tr>
          </template>
        </v-data-table>
      </v-col>
    </v-row>
  </v-container>
</template>

<script>
import axios from "axios";
import FavoriteButton from "@/components/FavoriteButton.vue";
import SentimentDisplay from "@/components/SentimentDisplay.vue";

export default {
  name: "DiarylistView",
  components: { FavoriteButton, SentimentDisplay },
  data() {
    return {
      diaries: [],
      loading: false,
      error: null,
      sortBy: 'created_at_jst',
      sortDesc: true,
      headers: [
        { text: "‰ΩúÊàêÊó•", value: "created_at_jst" },
        { text: "Êó•Ë®òÊú¨Êñá", value: "text" },
        { text: "AI„Ç≥„É°„É≥„Éà", value: "ai_text" },
        { text: "ÊÑüÊÉÖ„Çπ„Ç≥„Ç¢", value: "sentiment" },
        { text: "Êìç‰Ωú", value: "actions", sortable: false },
      ],

      // „Éï„Ç£„É´„Çø„ÉºÁî®
      sentimentOptions: [
        "üòä (0.2‰ª•‰∏ä)",
        "üòê (-0.2ÔΩû0.2)",
        "üò¢ (-0.2‰ª•‰∏ã)"
      ],
      filterSentiment: null,
      dateMenu: false,
      filterDate: null,
      filterDateText: "",
      dateTypeOptions: ["„Åù„ÅÆÊó•", "‰ª•Ââç", "‰ª•Èôç"],
      filterDateType: "„Åù„ÅÆÊó•",
      showFavoritesOnly: false,
    };
  },
  computed: {
    filteredDiaries() {
      return this.diaries.filter(d => {
        let pass = true;

        // ÊÑüÊÉÖ„Çπ„Ç≥„Ç¢„ÅßÁµû„ÇäËæº„Åø
        if (this.filterSentiment) {
          if (this.filterSentiment.startsWith("üòä")) pass = d.sentiment > 0.2;
          else if (this.filterSentiment.startsWith("üòê")) pass = d.sentiment >= -0.2 && d.sentiment <= 0.2;
          else if (this.filterSentiment.startsWith("üò¢")) pass = d.sentiment < -0.2;
        }

        // Êó•‰ªò„ÅßÁµû„ÇäËæº„ÅøÔºàÊôÇÈñì„ÅØÁÑ°Ë¶ñ„Åó„Å¶Âπ¥ÊúàÊó•„Å†„ÅëÔºâ
        if (this.filterDate) {
          const diaryDate = new Date(d.created_at_jst);
          const targetDate = new Date(this.filterDate);

          const diaryYMD = new Date(diaryDate.getFullYear(), diaryDate.getMonth(), diaryDate.getDate());
          const targetYMD = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate());

          if (this.filterDateType === "„Åù„ÅÆÊó•") {
            pass = pass && diaryYMD.getTime() === targetYMD.getTime();
          } else if (this.filterDateType === "‰ª•Ââç") {
            pass = pass && diaryYMD.getTime() <= targetYMD.getTime(); // ÈÅ∏ÊäûÊó•„ÇÇÂê´„ÇÄ
          } else if (this.filterDateType === "‰ª•Èôç") {
            pass = pass && diaryYMD.getTime() >= targetYMD.getTime(); // ÈÅ∏ÊäûÊó•„ÇÇÂê´„ÇÄ
          }
        }

        // „ÅäÊ∞ó„Å´ÂÖ•„ÇäÁµû„ÇäËæº„Åø
      if (this.showFavoritesOnly) {
        pass = pass && d.is_favorite;
      }

        return pass;
      });
    },
  },
  watch: {
    filterDate(val) {
      this.filterDateText = val ? this.formatDateYMD(val) : "";
    },
  },
  methods: {
    async fetchDiaries() {
      this.loading = true;
      this.error = null;
      try {
        const userId = this.$store.state.userId;
        const res = await axios.get(
          "https://m3h-kkikuchi-0820functionapi.azurewebsites.net/api/diaries",
          { params: { userId } }
        );
        this.diaries = res.data;
      } catch (err) {
        console.error(err);
        this.error = "Êó•Ë®ò„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü";
      } finally {
        this.loading = false;
      }
    },
    // ‰ΩúÊàêÊó•„ÇÑÊó•‰ªò„Éï„Ç£„É´„Çø„ÉºË°®Á§∫Áî®ÔºàÊôÇÈñì„Å™„ÅóÔºâ
    formatDateYMD(dt) {
      const date = new Date(dt);
      if (isNaN(date.getTime())) return "";
      return date.toLocaleDateString("ja-JP");
    },
    // Ë©≥Á¥∞Ë°®Á§∫Áî®ÔºàÊôÇÈñì„ÅÇ„ÇäÔºâ
    formatDate(dt) {
      const date = new Date(dt);
      if (isNaN(date.getTime())) return "";
      return date.toLocaleString("ja-JP", {
        year: "numeric",
        month: "numeric",
        day: "numeric",
        hour: "numeric",
        minute: "numeric",
      });
    },
    truncateText(text, maxLength) {
      if (!text) return "";
      return text.length > maxLength ? text.substring(0, maxLength) + "..." : text;
    },
    goToDetail(item) {
      this.$router.push({ name: "DiaryDetail", params: { id: item.diary_id } });
    },
    async confirmDelete(diaryId) {
      if (!confirm("Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) return;
      try {
        const userId = this.$store.state.userId;
        await axios.delete(
          `https://m3h-kkikuchi-0820functionapi.azurewebsites.net/api/diaries/${diaryId}`,
          { params: { userId } }
        );
        alert("ÂâäÈô§„Åó„Åæ„Åó„Åü");
        this.fetchDiaries();
      } catch (err) {
        console.error(err);
        alert("ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
      }
    },
     clearAllFilters() {
    this.filterDate = null;
    this.filterDateText = "";
    this.filterDateType = "„Åù„ÅÆÊó•";
    this.filterSentiment = null;
    this.showFavoritesOnly = false;
    }
  },
  mounted() {
    this.fetchDiaries();
  },
};
</script>
